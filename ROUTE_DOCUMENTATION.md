# Документация по работе маршрутов и движения машины

## Обзор

Приложение такси отображает маршрут между точками отправления и назначения на карте, а также анимирует движение машины по этому маршруту во время поездки.

## Как работает отображение маршрута

### 1. Маркеры точек

На карте всегда отображаются две точки:
- **Зеленая точка** (32x32px) - точка отправления ("Откуда")
- **Красная точка** (32x32px) - точка назначения ("Куда")

Маркеры отображаются с использованием тестовых координат по умолчанию:
- Откуда: `[55.7558, 37.6173]` - Красная площадь, Москва
- Куда: `[55.7520, 37.6156]` - Тверская улица, Москва

### 2. Построение маршрута

Маршрут строится автоматически при наличии координат обеих точек:

**Компонент:** `RouteDisplay` в `components/MapView.tsx`

**Логика работы:**
1. Проверяет наличие координат `fromCoords` и `toCoords`
2. Валидирует координаты (проверка на NaN и Infinity)
3. Вызывает функцию `drawFallbackRoute()` для отрисовки маршрута
4. Во время поездки маршрут фиксируется и не перерисовывается

**Функция отрисовки:** `drawFallbackRoute()`

Создает прямую линию между двумя точками:
- Цвет: `#FCD34D` (желтый)
- Толщина: 8px
- Непрозрачность: 1.0

### 3. Расчет расстояния и времени

При построении маршрута автоматически рассчитываются:
- **Расстояние** - по формуле гаверсинуса (расстояние между двумя точками на сфере)
- **Время** - из расчета средней скорости 40 км/ч
- **Цена** - на основе расстояния, времени и выбранного класса автомобиля

## Как работает движение машины

### 1. Сохранение координат маршрута

При построении маршрута координаты сохраняются в store:
```typescript
routeCoordinates: [number, number][] | null
```

Это массив координат `[широта, долгота]` по которым проходит маршрут.

### 2. Анимация движения

**Компонент:** `OrderStatusPanel` в `components/OrderStatusPanel.tsx`

**Логика работы:**
1. При статусе `orderStatus === 'riding'` запускается анимация
2. Используется функция `getPointOnRoute()` для вычисления позиции машины на маршруте
3. Машина движется по точкам маршрута с плавной интерполяцией
4. Используется easing функция `easeInOutQuad` для плавного движения

**Функция `getPointOnRoute(progress: number)`:**

Вычисляет позицию машины на маршруте по прогрессу (0-1):
- Вычисляет общую длину маршрута
- Находит нужный сегмент по прогрессу
- Интерполирует позицию внутри сегмента

### 3. Обновление позиции машины

Позиция машины обновляется через `requestAnimationFrame`:
- Обновление происходит плавно, следуя по точкам маршрута
- Позиция сохраняется в `driver.location` в store
- Маркер машины отображается на карте в реальном времени

## Структура данных

### Store (rideStore.ts)

```typescript
{
  fromCoords: [number, number] | null,      // Координаты точки отправления
  toCoords: [number, number] | null,        // Координаты точки назначения
  routeCoordinates: [number, number][] | null, // Координаты маршрута для движения
  driver: {
    location?: [number, number]             // Текущая позиция машины
  }
}
```

## Важные моменты

1. **Маршрут всегда отображается** - если есть координаты обеих точек, маршрут рисуется автоматически
2. **Во время поездки маршрут фиксируется** - не перерисовывается при изменении координат
3. **Машина движется по точкам маршрута** - не по прямой, а следуя по сохраненным координатам
4. **Упрощенная логика** - убраны кэширование и сложные проверки, все работает напрямую

## Тестирование

Для тестирования:
1. При запуске приложения автоматически устанавливаются тестовые координаты
2. Маршрут должен отображаться сразу как желтая линия между точками
3. При заказе такси машина должна двигаться по маршруту от точки отправления к точке назначения

## Возможные проблемы

1. **Маршрут не отображается:**
   - Проверьте, что координаты установлены в store
   - Проверьте консоль браузера на ошибки
   - Убедитесь, что карта полностью загрузилась

2. **Машина не двигается:**
   - Проверьте, что `routeCoordinates` сохранены в store
   - Проверьте статус заказа (`orderStatus === 'riding'`)
   - Проверьте, что `driver.location` обновляется

3. **Маркеры не видны:**
   - Проверьте, что Leaflet загружен (`L` не null)
   - Проверьте координаты маркеров
   - Убедитесь, что маркеры добавлены на карту

